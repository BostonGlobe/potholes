---
title: "potholes"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(lubridate)
library(rgdal)
library(dplyr)
library(ggplot2)
library(scales)
library(ggmap)
library(zoo)
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
# Read csv.
potholes <- read.csv('../potholes.csv', strip.white=T, stringsAsFactors=F, row.names = NULL) %>%
  mutate(DATE.CLOSED.R = mdy(CLOSED_DT))
```

A note on the format: each question is followed by the R code that generates the answer. This is also known as **reproducible research**, a practice that's slowly being adopted by newspapers (e.g. [538](https://github.com/fivethirtyeight/data), [The Upshot](https://github.com/theupshot)). From [wikipedia](http://en.wikipedia.org/wiki/Reproducibility#Reproducible_research): "The term reproducible research refers to the idea that the ultimate product of academic research is the paper along with the full computational environment used to produce the results in the paper such as the code, data, etc. that can be used to reproduce the results and create new work based on the research."

***
#### In his most recent State of the City speech, Mayor Walsh claimed that the city "filled over 19,000 potholes - 50% more than in 2013." Let's look at the data. How many potholes were closed per year?
```{r, results='asis', fig.width=10, fig.height=6, warning=FALSE, message=FALSE}
data <- potholes %>%
  filter(!is.na(DATE.CLOSED.R)) %>%
  mutate(YEAR = year(DATE.CLOSED.R)) %>%
  group_by(YEAR) %>%
  summarise(POTHOLES = n())

knitr::kable(data)
```

***
#### That's a `r I(data[2,]$POTHOLES * 100 / data[1,]$POTHOLES) - 100`% increase. What does this look like over time?
```{r, results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}
data <- potholes %>%
  filter(!is.na(DATE.CLOSED.R)) %>%
  arrange(DATE.CLOSED.R) %>%
  group_by(DATE.CLOSED.R) %>%
  tally() %>%
  mutate(moving = rollmean(n, 1, align='center', na.pad=TRUE))

ggplot(data, aes(DATE.CLOSED.R, moving)) +
  geom_line() +
  ggtitle('Daily pothole closures') +
  xlab('Date') +
  ylab('Pothole closures per day')
```

***
#### According to this data, the city fixed `r I(max(data$moving))` in one day. So maybe there is some clerical error here. Maybe the crews submit pothole fixes in large batches. So maybe we should look at a 30-day moving average.
```{r, results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}
data <- potholes %>%
  filter(!is.na(DATE.CLOSED.R)) %>%
  arrange(DATE.CLOSED.R) %>%
  group_by(DATE.CLOSED.R) %>%
  tally() %>%
  mutate(moving = rollmean(n, 30, align='center', na.pad=TRUE))

ggplot(data, aes(DATE.CLOSED.R, moving)) +
  geom_line() +
  ggtitle('Daily pothole closures (30-day rolling mean)') +
  xlab('Date') +
  ylab('Pothole closures per day')
```

***
#### This shows that the city fixed over 100 potholes per day for a 3-month stretch. That's still quite high. Did all districts fix potholes at this speed? What does the data look like by district and source of complaint?
```{r, results='asis', out.width='910px', fig.width=10, fig.height=12, warning=FALSE, message=FALSE, dpi=50}
data <- potholes %>%
  filter(
    !is.na(DATE.CLOSED.R),
    pwd_district != ''
  ) %>%
  arrange(DATE.CLOSED.R) %>%
  group_by(DATE.CLOSED.R, pwd_district, Source) %>%
  tally() %>%
  group_by(pwd_district, Source) %>%
  ungroup()

ggplot(data, aes(DATE.CLOSED.R, n)) +
  geom_line() +
  facet_grid(pwd_district ~ Source) +
  ggtitle('Daily pothole closures by district and source') +
  xlab('Date') +
  ylab('Pothole closures per day')
```

***
#### This shows that District 2 fixed over 100 potholes in one day, and District 3 fixed over 500 potholes in one day, and just for Employee Generated complaints! Maybe all those potholes are located on the same spot?
```{r, results='asis', out.width='910px', fig.width=10, fig.height=7, warning=FALSE, message=FALSE, dpi=50, dev='jpeg'}

data <- potholes %>%
  filter(
    !is.na(DATE.CLOSED.R),
    pwd_district %in% c('2', '3')
  ) %>%
  arrange(DATE.CLOSED.R) %>%
  group_by(DATE.CLOSED.R, pwd_district) %>%
  tally() %>%
  group_by(pwd_district) %>%
  slice(which.max(n)) %>%
  inner_join(potholes, by=c('DATE.CLOSED.R', 'pwd_district')) %>%
  select(
    LATITUDE,
    LONGITUDE,
    pwd_district
  ) %>%
  group_by(LATITUDE, LONGITUDE, pwd_district) %>%
  tally() %>%
  ungroup() %>%
  arrange(desc(n))

district <- data %>% filter(pwd_district == '2')
map <- get_map(location=c(-71.1153, 42.29), zoom=13)
ggmap(map) +
  geom_point(aes(x=LONGITUDE, y=LATITUDE, size=n, alpha=0.05, colour=pwd_district), data=district) +
  geom_point(shape=1, aes(x=LONGITUDE, y=LATITUDE, size=n), data=district) +
  ggtitle('District 2 fixed all these potholes (184) in one day') +
  scale_size_area(max_size=20)

district <- data %>% filter(pwd_district == '3')
map <- get_map(location=c(min(district$LONGITUDE), min(district$LATITUDE), max(district$LONGITUDE), max(district$LATITUDE)), zoom=14)
ggmap(map) +
  geom_point(aes(x=LONGITUDE, y=LATITUDE, size=n, alpha=0.05, colour=pwd_district), data=district) +
  geom_point(shape=1, aes(x=LONGITUDE, y=LATITUDE, size=n), data=district) +
  ggtitle(str_c('District 3 fixed all these potholes (516) in one day')) +
  scale_size_area(max_size=20)
```

***
#### So this has to be a data entry mistake. We'll make the assumption that those fixes happened all throughout the month. So we'll use a 30-day rolling mean to find the moving average for Districts 2 and 3.
```{r, results='asis', out.width='910px', fig.width=10, fig.height=2, warning=FALSE, message=FALSE, dpi=50}

rollingMeanByDistrict <- function(district) {
  data <- potholes %>%
    filter(
      !is.na(DATE.CLOSED.R),
      pwd_district == district,
      Source == 'Employee Generated'
    ) %>%
    arrange(DATE.CLOSED.R) %>%
    group_by(DATE.CLOSED.R) %>%
    tally() %>%
    mutate(moving = rollmean(n, 30, align='center', na.pad=TRUE))
  
  ggplot(data, aes(DATE.CLOSED.R, moving)) +
    geom_line() +
    ggtitle(str_c('Daily pothole Employee Generated closures for district ', district, ' (30-day rolling mean)')) +
    xlab('Date') +
    ylab('Pothole closures per day')
}

rollingMeanByDistrict(2)
rollingMeanByDistrict(3)
```

***
#### This shows that 2-person crews have been, on average, fixing between 40 and 60 potholes per day, 7 days a week, for over 3 months.