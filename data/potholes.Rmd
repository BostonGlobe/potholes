---
title: "potholes"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(scales)
library(ggmap)
library(leaflet)

# Read csv.
potholes <- read.csv('../potholes.csv', strip.white=T, stringsAsFactors=F, row.names = NULL) %>%
  mutate(DATE.CLOSED.R = mdy(CLOSED_DT))
```

The following analysis is not meant for public consumption, at least not at the moment.

A note on the format: each question is followed by the R code that generates the answer. This is also known as **reproducible research**, a practice that's slowly being adopted by newspapers (e.g. [538](https://github.com/fivethirtyeight/data), [The Upshot](https://github.com/theupshot)). From [wikipedia](http://en.wikipedia.org/wiki/Reproducibility#Reproducible_research): "The term reproducible research refers to the idea that the ultimate product of academic research is the paper along with the full computational environment used to produce the results in the paper such as the code, data, etc. that can be used to reproduce the results and create new work based on the research."

***
### We're going to ignore `BOGUS` at first. Unless mentioned, we'll be plotting all rows.
#### How many potholes were closed per year?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}
data <- potholes %>%
  group_by(year(DATE.CLOSED.R)) %>%
  summarise(potholes = n())

knitr::kable(data)
```

***
#### What does this look like on a timeseries?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}
data <- potholes %>%
  filter(!is.na(DATE.CLOSED.R)) %>%
  group_by(DATE.CLOSED.R) %>%
  tally() %>%
  mutate(
    YEAR = year(DATE.CLOSED.R),
    DAY = yday(DATE.CLOSED.R)
  )

ggplot(data, aes(DAY, n)) +
  geom_line() +
  facet_grid(YEAR ~ .) +
  ggtitle('Daily pothole closures by year') +
  xlab('Day of year') +
  ylab('Pothole closures per day')
```

***
#### What's the distribution of total daily closures?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}
data <- potholes %>%
  filter(!is.na(DATE.CLOSED.R)) %>%
  group_by(DATE.CLOSED.R) %>%
  tally() %>%
  mutate(YEAR = year(DATE.CLOSED.R))

ggplot(data, aes(n)) +
  geom_histogram() +
  facet_grid(YEAR ~ .) +
  ggtitle('Distribution of daily pothole closures by year') +
  xlab('Pothole closures per day') +
  ylab('Frequency')
```

***
#### What areas saw the most number of closures in 2014?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}

minClosures <- 15

data <- potholes %>%
  filter(
    LATITUDE!=42.3594, LONGITUDE!=-71.0587,
    LATITUDE!=42.3601, LONGITUDE!=-71.0579,
    year(DATE.CLOSED.R) == 2014,
    !is.na(DATE.CLOSED.R),
    !is.na(LATITUDE),
    !is.na(LONGITUDE)
    ) %>%
  group_by(LATITUDE, LONGITUDE) %>%
  tally() %>%
  ungroup() %>%
  filter(n >= minClosures)

map <- get_map(location=c(min(data$LONGITUDE), min(data$LATITUDE), max(data$LONGITUDE), max(data$LATITUDE)), zoom=12)

ggmap(map) +
  geom_point(aes(x=LONGITUDE, y=LATITUDE, size=n, alpha=0.1, colour='red'), data=data) +
  geom_point(shape=1, aes(x=LONGITUDE, y=LATITUDE, size=n), data=data) +
  scale_size_continuous(range = c(4,20)) +
  ggtitle(str_c(nrow(data), ' areas with at least ', minClosures, ' closures in 2014'))
```


***
#### What areas saw the most number of daily closures in 2014?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}

minClosures <- 15

data <- potholes %>%
  filter(
    LATITUDE!=42.3594, LONGITUDE!=-71.0587,
    LATITUDE!=42.3601, LONGITUDE!=-71.0579,
    year(DATE.CLOSED.R) == 2014,
    !is.na(DATE.CLOSED.R),
    !is.na(LATITUDE),
    !is.na(LONGITUDE)
    ) %>%
  group_by(DATE.CLOSED.R, LATITUDE, LONGITUDE) %>%
  tally() %>%
  ungroup() %>%
  filter(n >= minClosures)

map <- get_map(location=c(min(data$LONGITUDE), min(data$LATITUDE), max(data$LONGITUDE), max(data$LATITUDE)), zoom=12)

ggmap(map) +
  geom_point(aes(x=LONGITUDE, y=LATITUDE, size=n, alpha=0.1, colour='red'), data=data) +
  geom_point(shape=1, aes(x=LONGITUDE, y=LATITUDE, size=n), data=data) +
  scale_size_continuous(range = c(4,20)) +
  ggtitle(str_c(nrow(data), ' areas with at least ', minClosures, ' daily closures in 2014'))
```

***
#### What's the distribution of daily pothole closures per area, by year?
```{r, results='asis', fig.width=12, fig.height=7, warning=FALSE, message=FALSE}
data <- potholes %>%
  filter(
    LATITUDE!=42.3594, LONGITUDE!=-71.0587,
    !is.na(DATE.CLOSED.R),
    !is.na(LATITUDE),
    !is.na(LONGITUDE)
    ) %>%
  group_by(DATE.CLOSED.R, LATITUDE, LONGITUDE) %>%
  tally() %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  mutate(YEAR = year(DATE.CLOSED.R))

ggplot(data, aes(n)) +
  geom_histogram(binwidth=1) +
  facet_grid(YEAR ~ .) +
  ggtitle('Distribution of daily pothole closures per area by year') +
  xlab('Pothole closures per day') +
  ylab('Frequency')
```
This graph shows that when multiple potholes are closed in the same area on the same day, most of the time that number is still in the single digits.

### TODO

- how long it takes to fix a pothole
- remove duplicates by looking at BOGUS, invalid, duplicate, also look at length of complaint
- 